%%{init: {
  "theme": "base",
  "themeVariables": {
    "primaryColor": "#DEEAF1",
    "primaryTextColor": "#1A1A1A",
    "primaryBorderColor": "#2E75B6",
    "lineColor": "#2E75B6",
    "secondaryColor": "#F0F4F8",
    "tertiaryColor": "#EAF3EA",
    "background": "#FFFFFF",
    "fontSize": "14px",
    "fontFamily": "Arial"
  }
}}%%

flowchart TB

    %% â”€â”€ SOURCE SYSTEMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph SOURCES["ğŸ—„ï¸  Source Systems  â€”  6 Global Regions"]
        direction LR
        ERP["ğŸ­ Legacy ERP<br/>Orders Â· Inventory<br/>Product master"]
        GA["ğŸ“Š Google Analytics<br/>Web &amp; app events<br/>Behavioural clickstream"]
        REG["ğŸŒ Regional Operations<br/>London Â· Paris Â· Copenhagen<br/>New York Â· Miami Â· Melbourne"]
        CRM2["ğŸ‘¥ Customer Data<br/>Account records<br/>B2B segmentation"]
    end

    %% â”€â”€ INGESTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph INGEST["âš™ï¸  Ingestion Layer  (GCP)"]
        direction LR
        BATCH["ğŸ”„ Batch ETL<br/>Python pipelines<br/>Scheduled Â· ERP / CSV / API"]
        STREAM["âš¡ GCP Pub/Sub<br/>Real-time event streaming<br/>App &amp; web events"]
        STAGE["ğŸª£ Cloud Storage<br/>Landing zone<br/>Raw file staging"]
    end

    %% â”€â”€ SNOWFLAKE MEDALLION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph BRONZE["ğŸ¥‰  Bronze Layer  â€”  Raw Vault  (Immutable Â· Full History)"]
        direction LR
        B1["ğŸ“¥ Raw Orders &amp; ERP<br/>Unmodified source records"]
        B2["ğŸ“¥ Raw GA Events<br/>Clickstream Â· All properties"]
        B3["ğŸ“¥ Raw Regional Data<br/>Multi-currency Â· Multi-locale"]
    end

    subgraph SILVER["ğŸ¥ˆ  Silver Layer  â€”  Cleansed &amp; Conformed  (dbt transforms + DQ checks)"]
        direction LR
        S1["ğŸ”§ Cleansed Orders<br/>Deduplication Â· Nulls resolved<br/>Currency normalised to GBP"]
        S2["ğŸ”§ Customer Profiles<br/>Identity resolution<br/>Merged &amp; enriched"]
        S3["ğŸ”§ Product Catalogue<br/>SKU harmonisation<br/>Category &amp; margin mapping"]
    end

    subgraph GOLD["ğŸ¥‡  Gold Layer  â€”  Analytics-Ready Domain Models  (RBAC enforced)"]
        direction LR
        G1["ğŸ“¦ Orders &amp; Revenue<br/>Fact table<br/>Grain: Region Â· Product Â· Customer"]
        G2["ğŸ‘¤ Customer 360<br/>LTV Â· Segment Â· Frequency<br/>Churn risk score"]
        G3["ğŸ“ˆ Product Performance<br/>Basket analysis inputs<br/>Category trends &amp; velocity"]
        G4["ğŸŒ Regional Ops<br/>Fulfilment &amp; delivery KPIs<br/>By region &amp; product line"]
    end

    %% â”€â”€ CONSUMPTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph CONSUME["ğŸ“Š  Consumption Layer"]
        direction LR
        TAB["ğŸ“ˆ Tableau Dashboards<br/>Product Â· Commercial Â· Ops<br/>C-suite &amp; team reporting"]
        ML["ğŸ¤– ML Feature Store<br/>Feeds CS2 Rec Engine<br/>Apriori + k-NN training inputs"]
        APIS["ğŸ”Œ Analytics API<br/>Embedded metrics<br/>Internal product tooling"]
    end

    %% â”€â”€ GOVERNANCE PANEL (no cross-arrows) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph GOV["ğŸ”  Data Governance &amp; Quality  (Applied Across All Layers)"]
        direction LR
        DQ["âœ… Data Quality Gates<br/>Schema Â· Null Â· Range<br/>Referential integrity checks"]
        RBAC["ğŸ”‘ Snowflake RBAC<br/>Role-based access per domain<br/>Column-level security on PII"]
        GDPR2["âš–ï¸ GDPR Controls<br/>PII tagging &amp; dynamic masking<br/>Retention &amp; deletion policies"]
        MON["ğŸ”” Pipeline Monitoring<br/>SLA alerting<br/>Data freshness &amp; lineage tracking"]
    end

    %% â”€â”€ OUTCOMES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph OUT["ğŸ†  Business Outcomes"]
        direction LR
        O1["ğŸ“Š Unified analytics<br/>across 6 regions<br/>Single source of truth"]
        O2["ğŸ¤– ML training data<br/>enabled Rec Engine<br/>â†’ +Â£124K annual revenue"]
        O3["ğŸ“‰ Inventory waste<br/>reduced via<br/>demand signals"]
        O4["ğŸ¢ Data-driven culture<br/>adopted at CTO<br/>&amp; COO level"]
    end

    %% â”€â”€ FLOWS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ERP & CRM2 -->|"Scheduled batch"| BATCH
    GA & REG -->|"Real-time events"| STREAM
    BATCH & STREAM --> STAGE

    STAGE -->|"Bronze load"| B1 & B2 & B3

    B1 & B2 & B3 -->|"dbt SQL transforms<br/>+ data quality gates"| S1 & S2 & S3

    S1 & S2 & S3 -->|"Domain modelling<br/>aggregate &amp; enrich"| G1 & G2 & G3 & G4

    G1 & G2 & G3 & G4 --> TAB
    G2 & G3 -->|"Feature vectors"| ML
    G1 & G4 --> APIS

    CONSUME --> OUT

    %% â”€â”€ STYLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    classDef sourceStyle  fill:#FFF8DC,stroke:#DAA520,color:#1A1A1A
    classDef ingestStyle  fill:#E3F2FD,stroke:#1565C0,color:#1A1A1A
    classDef bronzeStyle  fill:#FBE9E7,stroke:#BF360C,color:#1A1A1A
    classDef silverStyle  fill:#ECEFF1,stroke:#546E7A,color:#1A1A1A
    classDef goldStyle    fill:#FFFDE7,stroke:#F9A825,color:#1A1A1A
    classDef consumeStyle fill:#E8F5E9,stroke:#388E3C,color:#1A1A1A
    classDef govStyle     fill:#F3E5F5,stroke:#6A1B9A,color:#1A1A1A
    classDef outStyle     fill:#E8F5E9,stroke:#2E7D32,color:#1A1A1A

    class ERP,GA,REG,CRM2 sourceStyle
    class BATCH,STREAM,STAGE ingestStyle
    class B1,B2,B3 bronzeStyle
    class S1,S2,S3 silverStyle
    class G1,G2,G3,G4 goldStyle
    class TAB,ML,APIS consumeStyle
    class DQ,RBAC,GDPR2,MON govStyle
    class O1,O2,O3,O4 outStyle
