%%{init: {
  "theme": "base",
  "themeVariables": {
    "primaryColor": "#DEEAF1",
    "primaryTextColor": "#1A1A1A",
    "primaryBorderColor": "#2E75B6",
    "lineColor": "#2E75B6",
    "secondaryColor": "#F0F4F8",
    "tertiaryColor": "#EAF3EA",
    "background": "#FFFFFF",
    "fontSize": "15px",
    "fontFamily": "Arial"
  }
}}%%

flowchart TB

    %% â”€â”€ INPUT LAYER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph REGIONS["ðŸ“§  Customer Regions  (6 Global)"]
        direction LR
        R1["ðŸ‡¬ðŸ‡§ London"]
        R2["ðŸ‡«ðŸ‡· Paris"]
        R3["ðŸ‡©ðŸ‡° Copenhagen"]
        R4["ðŸ‡ºðŸ‡¸ New York"]
        R5["ðŸ‡ºðŸ‡¸ Miami"]
        R6["ðŸ‡¦ðŸ‡º Melbourne"]
    end

    %% â”€â”€ INGESTION LAYER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph INGEST["â˜ï¸  GCP â€” Ingestion Layer"]
        EM["ðŸ“¬ Gmail / SMTP\nEmail Receiver"]
        PS["ðŸ“¨ Cloud Pub/Sub\nAsync Message Router"]
    end

    %% â”€â”€ AI PROCESSING LAYER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph AI["ðŸ¤–  GCP â€” GenAI Processing Layer"]
        CF["âš¡ Cloud Function\nEvent Trigger & Orchestrator"]
        LLM["ðŸ§  LLM Agent\n(GPT-4 / Claude API)\nStructured Order Extraction"]
        VAL["âœ… Validation Service\nSchema + Business Rules Check"]
    end

    %% â”€â”€ INTEGRATION LAYER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph INTEGRATION["ðŸ”Œ  Integration Layer"]
        CAT["ðŸ“¦ Product Catalogue API\nSKU & Pricing Lookup"]
        ACC["ðŸ‘¤ Customer Account API\nCredit Limit & Entitlements"]
    end

    %% â”€â”€ OUTPUT LAYER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph OUTPUT["ðŸ­  Output Layer"]
        ERP["ðŸ—‚ï¸ Order Management\nSystem (ERP)"]
        HRQ["ðŸ‘©â€ðŸ’¼ Human Review Queue\nException Handling"]
        CONF["ðŸ“© Confirmation Email\nAuto-Response to Customer"]
    end

    %% â”€â”€ OBSERVABILITY LAYER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph OBS["ðŸ“Š  Observability & Feedback Layer"]
        SF["â„ï¸ Snowflake\nAudit Log & Exception Store"]
        TB["ðŸ“ˆ Tableau Dashboard\nProcessing KPIs & Error Rates"]
        FB["ðŸ” Prompt Feedback Loop\nCorrection Capture â†’ Retraining"]
    end

    %% â”€â”€ FLOWS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    R1 & R2 & R3 & R4 & R5 & R6 -->|"Unstructured order emails"| EM
    EM -->|"Ingest & queue"| PS
    PS -->|"Trigger on new message"| CF
    CF -->|"Raw email payload"| LLM
    LLM -->|"Structured JSON (items, qty, notes)"| VAL
    VAL -->|"SKU lookup"| CAT
    VAL -->|"Account check"| ACC
    CAT & ACC -->|"Validated order data"| VAL
    VAL -->|"âœ… Valid order"| ERP
    VAL -->|"âŒ Exception (ambiguous / invalid)"| HRQ
    ERP -->|"Order confirmed"| CONF
    CONF -->|"Auto-reply to customer"| R1
    HRQ -->|"Human correction captured"| FB
    CF & ERP & HRQ -->|"All events logged"| SF
    SF -->|"Metrics feed"| TB
    FB -->|"Improved prompts deployed"| CF

    %% â”€â”€ STYLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    classDef regionStyle fill:#FFF8DC,stroke:#DAA520,color:#1A1A1A,rx:8
    classDef ingestStyle fill:#DEEAF1,stroke:#2E75B6,color:#1A1A1A,rx:8
    classDef aiStyle fill:#EDE7F6,stroke:#7B1FA2,color:#1A1A1A,rx:8
    classDef integStyle fill:#E8F5E9,stroke:#388E3C,color:#1A1A1A,rx:8
    classDef outputStyle fill:#FFF3E0,stroke:#E65100,color:#1A1A1A,rx:8
    classDef obsStyle fill:#E3F2FD,stroke:#1565C0,color:#1A1A1A,rx:8

    class R1,R2,R3,R4,R5,R6 regionStyle
    class EM,PS ingestStyle
    class CF,LLM,VAL aiStyle
    class CAT,ACC integStyle
    class ERP,HRQ,CONF outputStyle
    class SF,TB,FB obsStyle
