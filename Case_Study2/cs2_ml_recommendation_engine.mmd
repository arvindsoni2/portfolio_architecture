%%{init: {
  "theme": "base",
  "themeVariables": {
    "primaryColor": "#DEEAF1",
    "primaryTextColor": "#1A1A1A",
    "primaryBorderColor": "#2E75B6",
    "lineColor": "#2E75B6",
    "secondaryColor": "#F0F4F8",
    "tertiaryColor": "#EAF3EA",
    "background": "#FFFFFF",
    "fontSize": "14px",
    "fontFamily": "Arial"
  }
}}%%

flowchart TB

    %% â”€â”€ DATA SOURCES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph SOURCES["ğŸ—„ï¸  Data Sources"]
        direction LR
        ERP["ğŸ­ ERP<br/>Order History"]
        CRM["ğŸ‘¥ Customer Master<br/>Segmentation & Accounts"]
        CAT["ğŸ“¦ Product Catalogue<br/>SKUs, Categories, Pricing"]
    end

    %% â”€â”€ SNOWFLAKE FEATURE STORE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph DW["â„ï¸  Snowflake  â€”  Medallion Architecture  â€”  Feature Store"]
        direction LR
        BRZ["ğŸ¥‰ Bronze Layer<br/>Raw Ingested Data"]
        SLV["ğŸ¥ˆ Silver Layer<br/>Cleaned & Joined<br/>Customer Ã— Product Ã— Order"]
        GLD["ğŸ¥‡ Gold Layer<br/>ML-Ready Feature Tables<br/>basket matrix Â· purchase vectors"]
        BRZ --> SLV --> GLD
    end

    %% â”€â”€ ALGORITHM A â€” APRIORI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph APRIORI["ğŸ“  Algorithm A  â€”  Market Basket Analysis  (Apriori)"]
        direction TB
        AP1["âš™ï¸ Apriori<br/>mlxtend<br/>Frequent Itemset Mining"]
        AP2["ğŸ“‹ Association Rules<br/>Support / Confidence / Lift<br/>Filtering & Ranking"]
        AP3["ğŸ’¾ Rule Store<br/>item_A â†’ item_B<br/>lift score"]
        AP1 --> AP2 --> AP3
    end

    %% â”€â”€ ALGORITHM B â€” k-NN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph KNN["ğŸ¤  Algorithm B  â€”  Collaborative Filtering  (k-NN)"]
        direction TB
        KN1["âš™ï¸ k-NN Model<br/>scikit-learn<br/>Customer Similarity Matrix"]
        KN2["ğŸ” Nearest Neighbours<br/>Top-K Similar Customers<br/>Purchase Profile Matching"]
        KN3["ğŸ’¾ Similarity Store<br/>customer_id â†’ neighbour_ids<br/>weighted scores"]
        KN1 --> KN2 --> KN3
    end

    %% â”€â”€ ENSEMBLE LAYER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph ENSEMBLE["ğŸ¯  Ensemble & Ranking Layer"]
        direction TB
        ENS["ğŸ”€ Recommendation Blender<br/>Merge Apriori + k-NN outputs<br/>De-duplicate & Score"]
        RANK["ğŸ† Ranking Engine<br/>Boost premium products<br/>Filter already-purchased<br/>Apply business rules"]
        ENS --> RANK
    end

    %% â”€â”€ A/B TESTING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph AB["ğŸ§ª  A/B Testing Framework  (Phased Rollout)"]
        direction LR
        SPLIT["âš–ï¸ Traffic Splitter<br/>Control: existing rules<br/>Treatment: ML model"]
        TRACK["ğŸ“Š Experiment Tracker<br/>Conversion Â· Basket Size<br/>Premium Product Adoption"]
        SPLIT --> TRACK
    end

    %% â”€â”€ SERVING LAYER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph SERVE["ğŸš€  Serving Layer  (GCP)"]
        direction LR
        CACHE["âš¡ Pre-computed Cache<br/>Top-N per customer segment"]
        API["ğŸ”Œ Recommendation API<br/>REST  /recommend?customer_id=X"]
        CACHE --> API
    end

    %% â”€â”€ CONSUMER TOUCHPOINTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph CONSUMERS["ğŸ›’  Consumer Touchpoints"]
        direction LR
        CHK["ğŸ›’ Checkout UI<br/>Customers like you also bought..."]
        SLS["ğŸ“§ Sales Team<br/>Personalised order suggestions"]
    end

    %% â”€â”€ OBSERVABILITY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph OBS["ğŸ“ˆ  Tableau  â€”  Business Outcomes Dashboard"]
        direction LR
        T1["ğŸ“Š Basket Size KPI<br/>+10% uplift"]
        T2["ğŸ’° Revenue Attribution<br/>Â£124K annual"]
        T3["ğŸ”¬ Premium Cannibalisation<br/>Monitor by SKU cohort<br/>+8% premium adoption"]
    end

    %% â”€â”€ FLOWS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ERP & CRM & CAT -->|"Daily ETL batch"| BRZ

    GLD -->|"Basket transaction matrix"| AP1
    GLD -->|"Customer purchase vectors"| KN1

    AP3 -->|"Candidate recs"| ENS
    KN3 -->|"Candidate recs"| ENS

    RANK -->|"ML cohort"| SPLIT
    TRACK -->|"Winner to production"| API

    RANK --> CACHE

    API --> CHK & SLS

    CHK & SLS -->|"Order events fed back"| BRZ

    RANK --> T1
    TRACK --> T2 & T3

    %% â”€â”€ STYLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    classDef sourceStyle  fill:#FFF8DC,stroke:#DAA520,color:#1A1A1A
    classDef dwStyle      fill:#DEEAF1,stroke:#2E75B6,color:#1A1A1A
    classDef aprioriStyle fill:#EDE7F6,stroke:#7B1FA2,color:#1A1A1A
    classDef knnStyle     fill:#E8F5E9,stroke:#388E3C,color:#1A1A1A
    classDef ensStyle     fill:#FFF3E0,stroke:#E65100,color:#1A1A1A
    classDef abStyle      fill:#FCE4EC,stroke:#C62828,color:#1A1A1A
    classDef serveStyle   fill:#E3F2FD,stroke:#1565C0,color:#1A1A1A
    classDef consStyle    fill:#F3E5F5,stroke:#6A1B9A,color:#1A1A1A
    classDef obsStyle     fill:#E8F5E9,stroke:#2E7D32,color:#1A1A1A

    class ERP,CRM,CAT sourceStyle
    class BRZ,SLV,GLD dwStyle
    class AP1,AP2,AP3 aprioriStyle
    class KN1,KN2,KN3 knnStyle
    class ENS,RANK ensStyle
    class SPLIT,TRACK abStyle
    class API,CACHE serveStyle
    class CHK,SLS consStyle
    class T1,T2,T3 obsStyle
